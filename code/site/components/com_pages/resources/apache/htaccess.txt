##
# Joomlatools Pages
#
# @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
# @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
# @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
##

## Begin - Joomlatools Pages - static cache
#

#Prevent direct access to the static cache
RewriteRule ^static - [END,R=404]

#Define the location of the static cache
RewriteRule .* - [E=KPATH_BASE:/]
RewriteRule .* - [E=KPATH_STATIC:/joomlatools-pages/cache/static]

#Cond: Do not serve from cache on normal browser refresh
RewriteCond %{HTTP:Cache-Control} ^(no-cache)$ [OR]
#Cond: Do not serve from cache on hard browser refresh
RewriteCond %{HTTP:Cache-Control} ^(max-age=0)$
RewriteRule .* - [S=4]

#Cond: Only return cache for GET request
RewriteCond %{REQUEST_METHOD} !GET [OR]
RewriteCond %{HTTP_COOKIE} /^(.*;)?joomla_user_state=logged_in(;.*)?$/
RewriteRule .* - [S=3]

#Rewrite index.html
RewriteCond "expr=%{REQUEST_URI} =~ %{ENV:KPATH_BASE}"
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_STATIC}/%{REQUEST_URI}/index\.html -s
RewriteRule .* %{ENV:KPATH_STATIC}/%{REQUEST_URI}/index\.html [T=text/html,END]

#Rewrite /path/to/page.html
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_STATIC}/%{REQUEST_URI}\.html -s
RewriteRule .* %{ENV:KPATH_STATIC}/%{REQUEST_URI}\.html [T=text/html,END]

#Rewrite /path/to/page.[format]
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_STATIC}/%{REQUEST_URI} -s
RewriteRule .* %{ENV:KPATH_STATIC}/%{REQUEST_URI} [END]

#Header: Set Cache-Status=STATIC (if response is served from static cache)
Header set Cache-Status "STATIC" "expr=%{REQUEST_URI} =~ /static/"

#Header: Set Cache-Control=max-age=1day (set a specific cache expire time)
#Header set Cache-Control "max-age=86400"  "expr=%{REQUEST_URI} =~ /static/"

#Header: Set Cache-Control=no-cache (prevent cache to force cache revaliation on each request)
#Header set Cache-Control "no-cache"

#
## End - Joomlatool Pages - static cache