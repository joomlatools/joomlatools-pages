##
# Joomlatools Pages
#
# @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
# @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
# @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
##

## Begin - Joomlatools Pages - static cache
#

# Define the filesystem location of the static cache
SetEnvIf Request_URI "^.*" KPATH_PAGES_STATIC=/joomlatools-pages/cache/static

# Define the base folder
SetEnvIf Request_URI "^.*" BASE=/

# Prevent direct access to the static cache
RewriteCond "expr=%{REQUEST_URI} =~ %{ENV:KPATH_PAGES_STATIC}"
RewriteRule .* - [END,R=404]

# Condition - Do not serve from cache on browser refresh
RewriteCond %{HTTP:Cache-Control} ^(no-cache)$ [OR]
RewriteCond %{HTTP:Cache-Control} ^(max-age=0)$
RewriteRule .* - [S=4]

# Condition - Only return cache for none logged in GET request
RewriteCond %{REQUEST_METHOD} !GET [OR]
RewriteCond %{HTTP_COOKIE} /^(.*;)?joomla_user_state=logged_in(;.*)?$/
RewriteRule .* - [S=3]

# Rewrite - /
RewriteCond "expr=%{REQUEST_URI} =~ %{ENV:BASE}"
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}/index\.html -s
RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}/index\.html [T=text/html,END,E=STATIC]

# Rewrite - /path/to/page.html
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}\.html -s
RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}\.html [T=text/html,END,E=STATIC]

# Rewrite - /path/to/page.[format]
RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI} -s
RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI} [END,E=STATIC]

# Mark response as STATIC
Header set Cache-Status "STATIC" env=STATIC

# Force explicit browser and proxy cache expiration
#Header set Cache-Control "max-age=86400" env=STATIC

# Force cache revaliation
#Header set Cache-Control "no-cache" env=STATIC

#
## End - Joomlatools Pages - static cache