##
# Joomlatools Pages
#
# @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
# @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
# @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
##

## Begin - Joomlatools Pages - static cache
#

# Define the filesystem location of the static cache
SetEnvIf Request_URI "^.*" KPATH_PAGES_STATIC=/joomlatools-pages/cache/static

# Define the base folder
SetEnvIf Request_URI "^.*" BASE=/

# Prevent direct access to the static cache
RewriteCond "expr=%{REQUEST_URI} =~ %{ENV:KPATH_PAGES_STATIC}"
RewriteRule .* - [END,R=404]

    ## Begin - Try to find a cached page
    #
    # - Condition: Only return cache for GET request
    # - Condition: Do not serve from cache on normal browser refresh
    # - Condition: Do not serve from cache on hard browser refresh
    # - Condition: Only return cache for none logged in GET request

    <If "req('Cache-Control') != 'no-cache' && req('Cache-Control') != 'max-age=0'">

        # Condition - Only return cache for none logged in GET request
        RewriteCond %{REQUEST_METHOD} !GET [OR]
        RewriteCond %{HTTP_COOKIE} /^(.*;)?joomla_user_state=logged_in(;.*)?$/
        RewriteRule .* - [S=3]

        # Rewrite - /path/to/page.[format]
        RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI} -s
        RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI} [S=2]

        # Rewrite - /path/to/page.html
        RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}\.html -s
        RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}\.html [T=text/html,S=1]

        # Rewrite - /
        RewriteCond "expr=%{REQUEST_URI} =~ %{ENV:BASE}"
        RewriteCond %{DOCUMENT_ROOT}/%{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}/index\.html -s
        RewriteRule .* %{ENV:KPATH_PAGES_STATIC}/%{REQUEST_URI}/index\.html [T=text/html]

    </If>

    #
    ## End - Try to find a cached page

    ## Begin - Handle cache control for responses from static cache
    #
    <If "-s '%{DOCUMENT_ROOT}/%{REQUEST_URI}'">

        # Use the sendfile support from the kernel to transmit file contents to the client
        # See: https://httpd.apache.org/docs/2.4/mod/core.html#EnableSendfile
        EnableSendfile On

        # Mark response as STATIC
        Header set Cache-Status "STATIC"

        # Follwoing rules can be uncommented if required

        # Force explicit browser and proxy cache expiration
        #Header set Cache-Control "max-age=86400"

        # Force cache revaliation
        #Header set Cache-Control "no-cache"

    </If>

    #
    ## End -  Handle cache control for responses from static cache

#
## End - Joomlatools Pages - static cache