/**
 * Joomlatools Pages
 *
 * @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
 */

// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&dn=gpl-3.0.txt Expat
class Prefetcher{constructor(e){this.cache=new Set,this.hoverTimer,this.hoverTimestamp;var t={onload:!1,onhover:!0,onclick:!1,limit:1/0,throttle:1/0,delay:100,timeout:1e3,savedata:!0,elements:"a",origins:[location.hostname],ignored:[e=>e.includes("#")],debug:!1};this.options={...t,...e},this.log("Prefetcher Options",this.options),this.options.onload&&this.onLoad(),this.options.onhover&&this.onHover(),this.options.onclick&&this.onClick()}onClick(){document.addEventListener("mousedown",function(e){if(!(this.hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&this.prerender(t.href,"click")}}.bind(this),{capture:!0,passive:!0})}onHover(){document.addEventListener("touchstart",function(e){var t=e.target;this.isPrefetchable(t)&&(this.hoverTimestamp=performance.now(),this.prerender(t.href,"touch"))}.bind(this),{capture:!0,passive:!0}),document.addEventListener("mouseover",function(e){if(!(this.hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&(this.hoverTimer=setTimeout(()=>{this.prerender(t.href,"hover"),this.hoverTimer=!1},this.options.delay),t.addEventListener("mouseout",function(e){this.hoverTimer&&(clearTimeout(this.hoverTimer),this.hoverTimer=void 0)}.bind(this),{capture:!0,passive:!0}))}}.bind(this),{capture:!0,passive:!0})}onLoad(){if(!window.IntersectionObserver)return;const e=navigator.connection;if(e&&this.options.savedata&&(e.effectiveType.includes("2g")||e.saveData))return;const[t,r]=this.throttle(this.options.throttle);var o=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(o.unobserve(e=e.target),this.cache.size<this.options.limit&&t(()=>{this.prefetch(e.href,"load").then(r).catch(e=>{r()})}))})});return window.requestIdleCallback(()=>{document.querySelectorAll(this.options.elements).forEach(e=>{e instanceof HTMLAnchorElement?this.isPrefetchable(e)&&o.observe(e):e.querySelectorAll("a").forEach(e=>{this.isPrefetchable(e)&&o.observe(e)})})},{timeout:this.options.timeout}),function(){o.disconnect()}}prerender(e,t){var r;e=new URL(e,location.href).toString();return this.cache.has(e)||(this.cache.add(e),(r=this.canPrerender()?this.prerenderViaDOM(e):fetch(e,{credentials:"include"})).then(r=>this.log("Prerendered on "+t+":",e))),Promise.all([r])}prefetch(e,t){var r;e=new URL(e,location.href).toString();return this.cache.has(e)||(this.cache.add(e),(r=this.canPrefetch()?this.prefetchViaDOM(e):this.prefetchViaXHR(e)).then(r=>this.log("Prefetched on "+t+":",e))),Promise.all([r])}prerenderViaDOM(e){return new Promise((t,r,o)=>{(o=document.createElement("link")).rel="prerender",o.href=e,o.as="document",o.onload=t(),o.onerror=r(),document.head.appendChild(o)})}prefetchViaDOM(e){return new Promise((t,r,o)=>{(o=document.createElement("link")).rel="prefetch",o.href=e,o.as="document",o.onload=t(),o.onerror=r(),document.head.appendChild(o)})}prefetchViaXHR(e){return new Promise((t,r,o)=>{(o=new XMLHttpRequest).open("GET",e,o.withCredentials=!0,!0),o.onload=(()=>{200===o.status?t():r()}),o.send()})}isPrefetchable(e){return!(!e||!e.href)&&(!e.download&&(e.href.split("#")[0]!==location.href.split("#")[0]&&(!(this.options.origins.length&&!this.options.origins.includes(new URL(e.href,location.href).hostname))&&(!!["http:","https:"].includes(e.protocol)&&!this.isIgnored(e,this.options.ignored)))))}isIgnored(e,t){return Array.isArray(t)?t.some(t=>this.isIgnored(e,t)):(t.test||t).call(t,e.href,e)}canPrefetch(){var e=document.createElement("link");return e.relList&&e.relList.supports&&e.relList.supports("prefetch")}canPrerender(){var e=document.createElement("link");return!window.chrome&&e.relList&&e.relList.supports&&e.relList.supports("prerender")}log(){this.options.debug&&console&&("function"==typeof console.log?console.log.apply(console,arguments):console.log&&console.log(arguments))}throttle(e){e=e||1;var t=[],r=0;function o(){r<e&&t.length>0&&(t.shift()(),r++)}return[function(e){t.push(e)>1||o()},function(){r--,o()}]}}window.requestIdleCallback=window.requestIdleCallback||function(e){var t=Date.now();return setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)};// @license-end