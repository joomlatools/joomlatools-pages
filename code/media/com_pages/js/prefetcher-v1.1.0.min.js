/**
 * Joomlatools Pages
 *
 * @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
 */

class Prefetcher{constructor(e){this.cache=new Set,this._hoverTimer,this._hoverTimestamp,this.config=this.getSessionStorage().get("config")?this.getSessionStorage().get("config"):{};var t={onload:!1,onhover:!0,onclick:!1,limit:1/0,throttle:1/0,delay:100,timeout:1e3,savedata:!0,selector:"a",ignored:[e=>e.includes("#")],origins:[location.hostname],debug:!1};this.initalize({...t,...e,...this.config}),window.Prefetcher=this,window.addEventListener("beforeunload",e=>{this.config&&this.getSessionStorage().set("config",this.config)})}initalize(e){this.dispatchEvent("initialize",e,!0)?(this.options=e,this.log("Prefetcher Initialize Completed",this.options),this.options.onload&&this.onLoad(),this.options.onhover&&this.onHover(),this.options.onclick&&this.onClick()):this.log("Prefetcher Initialize Prevented",this.options)}prerender(e,t){var r;e=new URL(e,location.href).toString();return!this.cache.has(e)&&this.dispatchEvent("prerender",{url:e,context:t},!0)&&(this.cache.add(e),(r=this.canPrerender()?this.prerenderViaDOM(e):fetch(e,{credentials:"include"})).then(r=>this.log("Prerendered on "+t+":",e)),r.catch(e=>this.dispatchEvent("error",{error:e,context:t}))),Promise.all([r])}prefetch(e,t){var r;e=new URL(e,location.href).toString();return!this.cache.has(e)&&this.dispatchEvent("prefetch",{url:e,context:t},!0)&&(this.cache.add(e),(r=this.canPrefetch()?this.prefetchViaDOM(e):this.prefetchViaXHR(e)).then(r=>this.log("Prefetched on "+t+":",e)),r.catch(e=>this.dispatchEvent("error",{error:e,context:t}))),Promise.all([r])}onClick(){document.addEventListener("mousedown",function(e){if(!(this._hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&this.prerender(t.href,"click")}}.bind(this),{capture:!0,passive:!0})}onHover(){document.addEventListener("touchstart",function(e){var t=e.target;this.isPrefetchable(t)&&(this._hoverTimestamp=performance.now(),this.prerender(t.href,"touch"))}.bind(this),{capture:!0,passive:!0}),document.addEventListener("mouseover",function(e){if(!(this._hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&(this._hoverTimer=setTimeout(()=>{this.prerender(t.href,"hover"),this._hoverTimer=!1},this.options.delay),t.addEventListener("mouseout",function(e){this._hoverTimer&&(clearTimeout(this._hoverTimer),this._hoverTimer=void 0)}.bind(this),{capture:!0,passive:!0}))}}.bind(this),{capture:!0,passive:!0})}onLoad(){if(!window.IntersectionObserver)return;const e=navigator.connection;if(e&&this.options.savedata){if(e.saveData)return void this.log("Cannot load: Save-Data is enabled");if(e.effectiveType.includes("2g"))return void this.log("Cannot load: network conditions are poor")}const[t,r]=this._throttle(this.options.throttle);var o=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(o.unobserve(e=e.target),this.cache.size<this.options.limit&&t(()=>{this.prefetch(e.href,"load").then(r).catch(e=>{r()})}))})});return window.requestIdleCallback(()=>{document.querySelectorAll(this.options.selector).forEach(e=>{e instanceof HTMLAnchorElement?this.isPrefetchable(e)&&o.observe(e):e.querySelectorAll("a").forEach(e=>{this.isPrefetchable(e)&&o.observe(e)})})},{timeout:this.options.timeout}),function(){o.disconnect()}}prerenderViaDOM(e){return new Promise((t,r,o)=>{(o=document.createElement("link")).rel="prerender",o.href=e,o.as="document",o.onload=t(),o.onerror=r(),document.head.appendChild(o)})}prefetchViaDOM(e){return new Promise((t,r,o)=>{(o=document.createElement("link")).rel="prefetch",o.href=e,o.as="document",o.onload=t(),o.onerror=r(),document.head.appendChild(o)})}prefetchViaXHR(e){return new Promise((t,r,o)=>{(o=new XMLHttpRequest).open("GET",e,o.withCredentials=!0,!0),o.onload=(()=>{200===o.status?t():r()}),o.send()})}isPrefetchable(e){return!(!e||!e.href)&&(!e.download&&(e.href.split("#")[0]!==location.href.split("#")[0]&&(!(this.options.origins.length&&!this.options.origins.includes(new URL(e.href,location.href).hostname))&&(!!["http:","https:"].includes(e.protocol)&&(!this.isIgnored(e,this.options.ignored)&&!!window.navigator.onLine)))))}isIgnored(e,t){return Array.isArray(t)?t.some(t=>this.isIgnored(e,t)):(t.test||t).call(t,e.href,e)}canPrefetch(){var e=document.createElement("link");return e.relList&&e.relList.supports&&e.relList.supports("prefetch")}canPrerender(){var e=document.createElement("link");return!window.chrome&&e.relList&&e.relList.supports&&e.relList.supports("prerender")}dispatchEvent(e,t,r=!1){var o=new CustomEvent("prefetcher:"+e,{cancelable:r,detail:t});return window.dispatchEvent(o)}log(){this.options.debug&&console&&("function"==typeof console.log?console.log.apply(console,arguments):console.log&&console.log(arguments))}getSessionStorage(){const e=this.constructor.name;return{get:function(t){var r=sessionStorage.getItem(e+":"+t);try{r=JSON.parse(r)}catch(e){}return r},set:function(t,r){var o,i=(o=r,{}.toString.call(o).match(/\s([a-z|A-Z]+)/)[1].toLowerCase());/object|array/.test(i)&&(r=JSON.stringify(r)),sessionStorage.setItem(e+":"+t,r)},remove:function(e){sessionStorage.removeItem(e)}}}_throttle(e){e=e||1;var t=[],r=0;function o(){r<e&&t.length>0&&(t.shift()(),r++)}return[function(e){t.push(e)>1||o()},function(){r--,o()}]}}window.requestIdleCallback=window.requestIdleCallback||function(e){const t=Math.floor(Date.now()/1e3);return setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Math.floor(Date.now()/1e3)-t))}})},1)};