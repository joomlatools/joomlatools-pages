/**
 * Joomlatools Pages
 *
 * @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
 */

class Prefetcher{constructor(a){this.cache=new Set(Array.from(this.getSessionStorage().load("cache"))),this._hoverTimer,this._hoverTimestamp,this.config=this.getSessionStorage().load("config");var b={onload:!1,onhover:!0,onclick:!1,limit:1/0,throttle:1/0,delay:100,timeout:1e3,savedata:!0,selector:"a",ignored:[a=>a.includes("#")],origins:[location.hostname],debug:!1};this.initalize({...b,...a,...this.config}),window.Prefetcher=this,window.addEventListener("beforeunload",()=>{this.config&&this.getSessionStorage().store("config",this.config),this.cache&&this.getSessionStorage().store("cache",Array.from(this.cache))})}initalize(a){this.dispatchEvent("initialize",a,!0)?(this.options=a,this.log("Initialize completed"),this.debug("options",this.options),this.options.onload&&this.onLoad(),this.options.onhover&&this.onHover(),this.options.onclick&&this.onClick()):(this.log("Initialize prevented"),this.debug("options",this.options))}prerender(a,b){var c,a=new URL(a,location.href).toString();return this.cache.has(a)?this.debug("Prerender cancelled on "+b+":",a):this.dispatchEvent("prerender",{url:a,context:b},!0)?(c=this.canPrerender()?this.prerenderViaDOM(a):fetch(a,{credentials:"include"}),c.then(()=>this.cache.add(a)),c.then(()=>this.log("Prerendered on "+b+":",a)),c.catch(a=>this.dispatchEvent("error",{error:a,context:b}))):this.debug("Prerender prevented on "+b+":",a),Promise.all([c])}prefetch(a,b){var c,a=new URL(a,location.href).toString();return this.cache.has(a)?this.debug("Prefetch cancelled on "+b+":",a):this.dispatchEvent("prefetch",{url:a,context:b},!0)?(c=this.canPrefetch()?this.prefetchViaDOM(a):this.prefetchViaXHR(a),c.then(()=>this.cache.add(a)),c.then(()=>this.log("Prefetched on "+b+":",a)),c.catch(a=>this.dispatchEvent("error",{error:a,context:b}))):this.debug("Prefetch prevented on "+b+":",a),Promise.all([c])}onClick(){document.addEventListener("mousedown",function(a){if(!(this._hoverTimestamp>performance.now()-500)){var b=a.target;this.isPrefetchable(b)&&this.prerender(b.href,"click")}}.bind(this),{capture:!0,passive:!0})}onHover(){document.addEventListener("touchstart",function(a){var b=a.target;this.isPrefetchable(b)&&(this._hoverTimestamp=performance.now(),this.prerender(b.href,"touch"))}.bind(this),{capture:!0,passive:!0}),document.addEventListener("mouseover",function(a){if(!(this._hoverTimestamp>performance.now()-500)){var b=a.target;this.isPrefetchable(b)&&(this._hoverTimer=setTimeout(()=>{this.prerender(b.href,"hover"),this._hoverTimer=!1},this.options.delay),b.addEventListener("mouseout",function(){this._hoverTimer&&(clearTimeout(this._hoverTimer),this._hoverTimer=void 0)}.bind(this),{capture:!0,passive:!0}))}}.bind(this),{capture:!0,passive:!0})}onLoad(){if(!window.IntersectionObserver)return;const a=navigator.connection;if(a&&this.options.savedata){if(a.saveData)return void this.log("Load disabled: Save-Data is enabled");if(a.effectiveType.includes("2g"))return void this.log("Load disabled: network conditions are poor")}const b=window.performance.navigation;if(b){if(b.type==PerformanceNavigation.TYPE_RELOAD)return this.log("Load disabled \xBB browser reloading | cache cleared"),void this.cache.clear();if(b.type==PerformanceNavigation.TYPE_BACK_FORWARD)return void this.log("Load disabled \xBB history traversal");this.log("Load enabled \xBB user navigation")}const[c,d]=this.getThrottledQueue(this.options.concurrency);var e=new IntersectionObserver(a=>{a.forEach(a=>{a.isIntersecting&&(e.unobserve(a=a.target),this.cache.size<this.options.limit&&c(()=>{this.prefetch(a.href,"load").then(d()).catch(()=>{d()})}))})});return window.requestIdleCallback(()=>{document.querySelectorAll(this.options.selector).forEach(a=>{a instanceof HTMLAnchorElement?this.isPrefetchable(a)&&e.observe(a):a.querySelectorAll("a").forEach(a=>{this.isPrefetchable(a)&&e.observe(a)})})},{timeout:this.options.timeout}),function(){e.disconnect()}}prerenderViaDOM(a){return new Promise((b,c,d)=>{d=document.createElement("link"),d.rel="prerender",d.href=a,d.as="document",d.onload=b(),d.onerror=c(),document.head.appendChild(d)})}prefetchViaDOM(a){return new Promise((b,c,d)=>{d=document.createElement("link"),d.rel="prefetch",d.href=a,d.as="document",d.onload=b(),d.onerror=c(),document.head.appendChild(d)})}prefetchViaXHR(a){return new Promise((b,c,d)=>{d=new XMLHttpRequest,d.open("GET",a,d.withCredentials=!0,!0),d.onload=()=>{200===d.status?b():c()},d.send()})}isPrefetchable(a){return!!(a&&a.href)&&!a.download&&a.href.split("#")[0]!==location.href.split("#")[0]&&(!this.options.origins.length||this.options.origins.includes(new URL(a.href,location.href).hostname))&&!!["http:","https:"].includes(a.protocol)&&!this.isIgnored(a,this.options.ignored)&&!!window.navigator.onLine}isIgnored(a,b){return Array.isArray(b)?b.some(b=>this.isIgnored(a,b)):(b.test||b).call(b,a.href,a)}canPrefetch(){var a=document.createElement("link");return a.relList&&a.relList.supports&&a.relList.supports("prefetch")}canPrerender(){return!1}dispatchEvent(a,b,c=!1){var d=new CustomEvent("prefetcher:"+a,{cancelable:c,detail:b});return window.dispatchEvent(d)}log(){var a=Array.from(arguments);a.unshift("%c["+this.constructor.name.toLowerCase()+"]","color: gray"),this.options.debug&&console&&("function"==typeof console.log?console.log.apply(console,a):console.log(a))}debug(){var a=Array.from(arguments);a.unshift("%c["+this.constructor.name.toLowerCase()+"]","color: gray"),"function"==typeof console.debug?console.debug.apply(console,a):console.debug(a)}getSessionStorage(){const a=this.constructor.name;return{load:function(b){var c={};if(sessionStorage.getItem(a+":"+b))try{c=JSON.parse(sessionStorage.getItem(a+":"+b))}catch(a){c={}}return c},store:function(b,c){sessionStorage.setItem(a+":"+b,JSON.stringify(c))},remove:function(a){sessionStorage.removeItem(a)}}}getThrottledQueue(a){function b(){e--,c()}function c(){e<a&&0<d.length&&(d.shift()(),e++)}a=a||1;var d=[],e=0;return[function(a){1<d.push(a)||c()},b]}}window.requestIdleCallback=window.requestIdleCallback||function(a){const b=Math.floor(Date.now()/1e3);return setTimeout(function(){a({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Math.floor(Date.now()/1e3)-b))}})},1)};