##
# Joomlatools Pages
#
# @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
# @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
# @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
##

# Define the filesystem locations (related to document root)
SetEnvIf Request_URI ^.*  PAGES_CACHE_PATH=joomlatools-pages/cache
SetEnvIf Request_URI ^.*  PAGES_IMAGES_PATH=images

# Define the filesystem locations (related to server root)
RewriteRule ^ - [E=PAGES_CACHE_ROOT:%{DOCUMENT_ROOT}%{ENV:PAGES_CACHE_PATH}]
RewriteRule ^ - [E=PAGES_IMAGES_ROOT:%{DOCUMENT_ROOT}%{ENV:PAGES_IMAGES_PATH}]

## Begin - Image Cache
#

   # Condition - Images only
   RewriteCond %{REQUEST_URI} !(?i)(.+)\.(jpe?g|png|gif|svg).*$
   RewriteRule .* - [S=3]

   # Find generated WebP image (if browser supports it)
   RewriteCond %{HTTP_ACCEPT} image/webp
   RewriteCond %{ENV:PAGES_CACHE_ROOT}/$1\.webp_%{QUERY_STRING} -f
   RewriteRule (.+)\.(jpe?g|png|gif|svg) %{ENV:PAGES_CACHE_PATH}/$1.webp_%{QUERY_STRING} [NC,T=image/webp,E=IMAGE:1,L]

   # Find generated image (in case browser doesn't support WebP)
   RewriteCond  %{ENV:PAGES_CACHE_ROOT}/$1\.$2_%{QUERY_STRING} -f
   RewriteRule (.+)\.(jpe?g|png|gif|svg) %{ENV:PAGES_CACHE_PATH}/$1.$2_%{QUERY_STRING} [NC,E=IMAGE:1,L]

   # Generate image
   RewriteCond %{ENV:REDIRECT_IMAGE} !=1
   RewriteRule images\/(.+)\.(jpe?g|png|gif|svg) image.php?cache_path=images&image_path=$1.$2 [NC,E=IMAGE,L,QSA]

   # Set cache to 1 year
   Header set Cache-Control public,max-age=31536000,immutable env=REDIRECT_IMAGE

   # Add Accept to the Vary header
   Header append Vary Accept env=REDIRECT_IMAGE

   # Remove Etag header (use Last-Modified to validate)
   Header unset ETag env=REDIRECT_IMAGE
#
## End - Image cache